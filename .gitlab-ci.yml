stages:
  - test
  - build

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"

cache:
  paths:
    - .m2/repository/

# Test each service
test:
  image: maven:3.9-openjdk-21
  stage: test
  script:
    - cd customer-service && mvn test
    - cd ../api-gateway && mvn test
    - cd ../service-registry && mvn test
    - cd ../RegistrationService && mvn test
    - cd ../email-service && mvn test
    - cd ../token-service && mvn test

# Build each service separately
build-customer-service:
  image: maven:3.9-openjdk-21
  stage: build
  script:
    - cd customer-service && mvn package -DskipTests
  artifacts:
    paths:
      - customer-service/target/*.jar
    expire_in: 1 hour

build-api-gateway:
  image: maven:3.9-openjdk-21
  stage: build
  script:
    - cd api-gateway && mvn package -DskipTests
  artifacts:
    paths:
      - api-gateway/target/*.jar
    expire_in: 1 hour

build-service-registry:
  image: maven:3.9-openjdk-21
  stage: build
  script:
    - cd service-registry && mvn package -DskipTests
  artifacts:
    paths:
      - service-registry/target/*.jar
    expire_in: 1 hour

build-registration-service:
  image: maven:3.9-openjdk-21
  stage: build
  script:
    - cd RegistrationService && mvn package -DskipTests
  artifacts:
    paths:
      - RegistrationService/target/*.jar
    expire_in: 1 hour

build-email-service:
  image: maven:3.9-openjdk-21
  stage: build
  script:
    - cd email-service && mvn package -DskipTests
  artifacts:
    paths:
      - email-service/target/*.jar
    expire_in: 1 hour

build-token-service:
  image: maven:3.9-openjdk-21
  stage: build
  script:
    - cd token-service && mvn package -DskipTests
  artifacts:
    paths:
      - token-service/target/*.jar
    expire_in: 1 hour